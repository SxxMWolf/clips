{% extends "base.html" %}

{% block title %}AI Prompt - Video Clips{% endblock %}

{% block content %}
<div class="page-container">
    <header class="page-header">
        <h1>AI Prompt Generation</h1>
        <p class="subtitle">Enter a topic to auto-generate viral prompts, hooks, and hashtags</p>
    </header>

    <section class="prompt-section">
        <!-- Input Area -->
        <div class="form-card">
            <h3>Enter Topic</h3>
            <div class="form-group">
                <label for="topic-input">Topic</label>
                <input type="text" id="topic-input" class="form-control"
                    placeholder="e.g. Future where AI replaces humans" autocomplete="off">
                <small class="form-hint">What kind of video/image do you want to create?</small>
            </div>

            <div class="form-group" style="margin-top: 15px;">
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input type="checkbox" id="asmr-mode"
                        style="width: 18px; height: 18px; accent-color: var(--accent);">
                    <span style="font-weight: 500;">ASMR Mode (Strict Rules)</span>
                </label>
                <small class="form-hint"
                    style="margin-left: 26px; margin-top: 4px; display: block; color: var(--text-muted);">
                    Apply strict ASMR requirements (Vertical, Macro, Start eating, etc.)
                </small>
            </div>

            <button id="generate-btn" class="btn btn-primary btn-large">
                Generate Prompt
            </button>
        </div>

        <!-- Result Area -->
        <div id="result-section" style="display: none;">
            <!-- AI Video/Image Prompt -->
            <div class="form-card">
                <h3>1. AI VIDEO / IMAGE PROMPT (ENGLISH)</h3>
                <div class="prompt-result">
                    <div id="video-prompt" class="prompt-text"></div>
                    <button class="btn btn-secondary copy-btn" data-target="video-prompt">
                        Copy
                    </button>
                </div>
            </div>

            <!-- Hook Caption -->
            <div class="form-card">
                <h3>2. HOOK CAPTION</h3>
                <div class="prompt-result">
                    <div id="hook-caption" class="prompt-text"></div>
                    <button class="btn btn-secondary copy-btn" data-target="hook-caption">
                        Copy
                    </button>
                </div>
            </div>

            <!-- Viral Hashtags -->
            <div class="form-card">
                <h3>3. VIRAL HASHTAGS</h3>
                <div class="prompt-result">
                    <div id="hashtags" class="hashtags-container"></div>
                    <button class="btn btn-secondary copy-btn" data-target="hashtags">
                        Copy
                    </button>
                </div>
            </div>
        </div>
    </section>
</div>
{% endblock %}

{% block scripts %}
<script>
    // localStorage keys
    const STORAGE_KEY = 'ai_prompt_result';
    const TOPIC_STORAGE_KEY = 'ai_prompt_topic';
    const ASMR_STORAGE_KEY = 'ai_prompt_asmr';

    // Save result to localStorage
    function saveResult(topic, result, promptType) {
        try {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(result));
            localStorage.setItem(TOPIC_STORAGE_KEY, topic);
        } catch (e) {
            console.warn('localStorage save failed:', e);
        }
    }

    // Load result from localStorage
    function loadResult() {
        try {
            const savedResult = localStorage.getItem(STORAGE_KEY);
            const savedTopic = localStorage.getItem(TOPIC_STORAGE_KEY);

            if (savedResult && savedTopic) {
                const result = JSON.parse(savedResult);
                return { topic: savedTopic, result: result };
            }
        } catch (e) {
            console.warn('localStorage load failed:', e);
        }
        return null;
    }

    // Display result function
    function displayResult(result) {
        const resultSection = document.getElementById('result-section');

        // Display text
        document.getElementById('video-prompt').textContent = result.video_prompt || '';
        document.getElementById('hook-caption').textContent = result.hook_caption || '';

        // Display hashtags
        const hashtagsContainer = document.getElementById('hashtags');
        if (result.hashtags && result.hashtags.length > 0) {
            hashtagsContainer.innerHTML = result.hashtags
                .map(tag => `<span class="hashtag-tag">${tag}</span>`)
                .join(' ');
        } else {
            hashtagsContainer.textContent = 'No hashtags';
        }

        resultSection.style.display = 'block';
    }

    document.addEventListener('DOMContentLoaded', () => {
        const topicInput = document.getElementById('topic-input');
        const generateBtn = document.getElementById('generate-btn');
        const resultSection = document.getElementById('result-section');

        // Restore saved result
        const saved = loadResult();
        const savedAsmr = localStorage.getItem(ASMR_STORAGE_KEY);
        const asmrCheckbox = document.getElementById('asmr-mode');

        if (savedAsmr === 'true') {
            asmrCheckbox.checked = true;
        }

        if (saved) {
            topicInput.value = saved.topic;
            displayResult(saved.result);
        } else {
            // Restore topic only if result missing
            const savedTopic = localStorage.getItem(TOPIC_STORAGE_KEY);
            if (savedTopic) {
                topicInput.value = savedTopic;
            }
        }

        // Save ASMR checkbox state
        asmrCheckbox.addEventListener('change', () => {
            localStorage.setItem(ASMR_STORAGE_KEY, asmrCheckbox.checked);
        });

        // Auto-save topic on input
        topicInput.addEventListener('input', () => {
            try {
                localStorage.setItem(TOPIC_STORAGE_KEY, topicInput.value);
            } catch (e) {
                console.warn('Topic save failed:', e);
            }
        });

        // Enter key to generate
        topicInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                generateBtn.click();
            }
        });

        // Generate button click
        generateBtn.addEventListener('click', async () => {
            const topic = topicInput.value.trim();
            const isAsmr = document.getElementById('asmr-mode').checked;

            if (!topic) {
                showToast('Please enter a topic', 'error');
                return;
            }

            // Disable button
            generateBtn.disabled = true;
            generateBtn.textContent = 'Generating...';
            resultSection.style.display = 'none';

            try {
                const response = await fetch('/api/ai/generate-prompt', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ topic, is_asmr: isAsmr })
                });

                const result = await response.json();

                if (result.success) {
                    // Display result
                    displayResult(result.data);

                    // Save to localStorage
                    saveResult(topic, result.data);

                    resultSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    showToast('Prompt generated!', 'success');
                } else {
                    showToast(result.message || 'Generation failed', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showToast('An error occurred: ' + error.message, 'error');
            } finally {
                generateBtn.disabled = false;
                generateBtn.textContent = 'Generate Prompt';
            }
        });

        // Copy button
        document.querySelectorAll('.copy-btn').forEach(btn => {
            btn.addEventListener('click', async () => {
                const targetId = btn.getAttribute('data-target');
                const targetElement = document.getElementById(targetId);

                let textToCopy = targetElement.textContent || '';

                try {
                    await navigator.clipboard.writeText(textToCopy);
                    showToast('Copied to clipboard', 'success');

                    // Temporary button text change
                    const originalText = btn.textContent;
                    btn.textContent = 'Copied!';
                    setTimeout(() => {
                        btn.textContent = originalText;
                    }, 2000);
                } catch (error) {
                    showToast('Copy failed', 'error');
                }
            });
        });
    });
</script>
{% endblock %}
{% extends "base.html" %}

{% block title %}홈 - Video Clips{% endblock %}

{% block content %}
<div class="page-container">
    <header class="page-header">
        <h1>쇼츠 영상 자동 병합</h1>
        <p class="subtitle">영상을 병합하고 AI 클립을 생성하세요</p>
    </header>

    <section class="dashboard">
        <div class="status-card">
            <h3>원본 영상</h3>
            <div class="status-info">
                <span id="raw-count">0</span> 개
            </div>
            <div id="raw-list" class="file-list"></div>
        </div>

        <div class="status-card">
            <h3>병합된 영상</h3>
            <div class="status-info">
                <span id="merged-status">없음</span>
            </div>
            <div id="merged-size" class="file-size"></div>
            <div id="merged-preview" class="video-preview"></div>
        </div>
    </section>

    <section class="quick-actions">
        <h2>빠른 작업</h2>
        <div class="action-grid">
            <a href="{{ url_for('merge_page') }}" class="action-card">
                <div class="action-icon"></div>
                <h3>영상 병합</h3>
                <p>여러 영상을 하나로 병합</p>
            </a>

            <a href="{{ url_for('ai_prompt_page') }}" class="action-card">
                <div class="action-icon"></div>
                <h3>AI 프롬프트</h3>
                <p>바이럴 프롬프트, 훅, 해시태그 자동 생성</p>
            </a>
        </div>
    </section>
</div>
{% endblock %}

{% block scripts %}
<script>
    // 상태 업데이트
    async function updateStatus() {
        try {
            const response = await fetch('/api/status');
            const status = await response.json();

            document.getElementById('raw-count').textContent = status.raw_count || 0;
            const rawList = document.getElementById('raw-list');
            if (status.raw_videos && status.raw_videos.length > 0) {
                rawList.innerHTML = status.raw_videos.map(video =>
                    `<div>${video}</div>`
                ).join('');
            } else {
                rawList.innerHTML = '<div style="color: #999;">영상이 없습니다</div>';
            }

            const mergedStatus = document.getElementById('merged-status');
            const mergedSize = document.getElementById('merged-size');
            const mergedPreview = document.getElementById('merged-preview');

            if (status.merged_exists && status.latest_merged) {
                mergedStatus.textContent = '준비됨';
                mergedStatus.style.color = '#fff';
                mergedSize.textContent = `크기: ${status.merged_size} MB`;

                // 기존 비디오 확인
                const existingVideo = mergedPreview.querySelector('video');
                const existingSource = existingVideo ? existingVideo.querySelector('source') : null;
                const currentSrc = existingSource ? existingSource.getAttribute('src') : '';
                const newSrc = `/videos/${status.latest_merged}`;

                // 파일명이 변경되었거나 비디오가 없을 때만 업데이트
                // 파일명에서 쿼리 파라미터 제거하여 비교
                const currentFilename = currentSrc ? currentSrc.split('?')[0].split('/').pop() : '';
                const newFilename = status.latest_merged;

                if (currentFilename !== newFilename) {
                    // 캐시 방지를 위한 타임스탬프 추가
                    const timestamp = new Date().getTime();
                    mergedPreview.innerHTML = `
                        <video controls style="width: 100%; border-radius: 10px; max-height: 300px;">
                            <source src="${newSrc}?t=${timestamp}" type="video/mp4">
                        </video>
                    `;
                }
            } else {
                mergedStatus.textContent = '없음';
                mergedStatus.style.color = '#999';
                mergedSize.textContent = '';
                mergedPreview.innerHTML = '';
            }
        } catch (error) {
            console.error('상태 업데이트 오류:', error);
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        updateStatus();
        setInterval(updateStatus, 5000);
    });
</script>
{% endblock %}
{% extends "base.html" %}

{% block title %}Home - Video Clips{% endblock %}

{% block content %}
<div class="page-container">
    <header class="page-header">
        <h1>Short Video Auto-Merge</h1>
        <p class="subtitle">Merge videos and create AI clips</p>
    </header>

    <section class="dashboard">
        <div class="status-card">
            <h3>Source Videos</h3>
            <div class="status-info">
                <span id="raw-count">0</span> files
            </div>
            <div id="raw-list" class="file-list"></div>
        </div>

        <div class="status-card">
            <h3>Merged Video</h3>
            <div class="status-info">
                <span id="merged-status">None</span>
            </div>
            <div id="merged-size" class="file-size"></div>
            <div id="merged-preview" class="video-preview"></div>
        </div>
    </section>

    <section class="quick-actions">
        <h2>Quick Actions</h2>
        <div class="action-grid">
            <a href="{{ url_for('merge_page') }}" class="action-card">
                <div class="action-icon"></div>
                <h3>Merge Videos</h3>
                <p>Merge multiple videos into one</p>
            </a>

            <a href="{{ url_for('ai_prompt_page') }}" class="action-card">
                <div class="action-icon"></div>
                <h3>AI Prompt</h3>
                <p>Auto-generate viral prompts, hooks, and hashtags</p>
            </a>
        </div>
    </section>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Status update
    async function updateStatus() {
        try {
            const response = await fetch('/api/status');
            const status = await response.json();

            document.getElementById('raw-count').textContent = status.raw_count || 0;
            const rawList = document.getElementById('raw-list');
            if (status.raw_videos && status.raw_videos.length > 0) {
                rawList.innerHTML = status.raw_videos.map(video =>
                    `<div>${video}</div>`
                ).join('');
            } else {
                rawList.innerHTML = '<div style="color: #999;">No videos</div>';
            }

            const mergedStatus = document.getElementById('merged-status');
            const mergedSize = document.getElementById('merged-size');
            const mergedPreview = document.getElementById('merged-preview');

            if (status.merged_exists && status.latest_merged) {
                mergedStatus.textContent = 'Ready';
                mergedStatus.style.color = '#fff';
                mergedSize.textContent = `Size: ${status.merged_size} MB`;

                // Check existing video
                const existingVideo = mergedPreview.querySelector('video');
                const existingSource = existingVideo ? existingVideo.querySelector('source') : null;
                const currentSrc = existingSource ? existingSource.getAttribute('src') : '';
                const newSrc = `/videos/${status.latest_merged}`;

                // Update only if filename changed or no video
                const currentFilename = currentSrc ? currentSrc.split('?')[0].split('/').pop() : '';
                const newFilename = status.latest_merged;

                if (currentFilename !== newFilename) {
                    // Add timestamp to prevent caching
                    const timestamp = new Date().getTime();
                    mergedPreview.innerHTML = `
                        <video controls style="width: 100%; border-radius: 10px; max-height: 300px;">
                            <source src="${newSrc}?t=${timestamp}" type="video/mp4">
                        </video>
                    `;
                }
            } else {
                mergedStatus.textContent = 'None';
                mergedStatus.style.color = '#999';
                mergedSize.textContent = '';
                mergedPreview.innerHTML = '';
            }
        } catch (error) {
            console.error('Status update error:', error);
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        updateStatus();
        setInterval(updateStatus, 5000);
    });
</script>
{% endblock %}